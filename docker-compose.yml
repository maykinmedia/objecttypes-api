services:
  db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: objecttypes
      POSTGRES_PASSWORD: objecttypes
    command: postgres -c max_connections=300 -c log_min_messages=LOG
    networks:
      - objecttypes-api-dev

  redis:
    image: redis
    networks:
      - objecttypes-api-dev

  web:
    image: maykinmedia/objecttypes-api:${TAG:-latest}
    build: .
    environment: &app-env
      DB_USER: objecttypes
      DB_PASSWORD: objecttypes
      DJANGO_SETTINGS_MODULE: objecttypes.conf.docker
      SECRET_KEY: ${SECRET_KEY:-fgv=c0hz&tl*8*3m3893@m+1pstrvidc9e^5@fpspmg%cyf15d}
      ALLOWED_HOSTS: '*'
      CACHE_DEFAULT: redis:6379/0
      CACHE_AXES: redis:6379/0
      DISABLE_2FA: yes
      SUBPATH: ${SUBPATH:-/}
      DB_CONN_MAX_AGE: "0"
      DB_POOL_ENABLED: True

      # Enabling Open Telemetry requires the services in docker/docker-compose.observability.yaml
      # to be up and running.
      OTEL_SDK_DISABLED: ${OTEL_SDK_DISABLED:-true}
      OTEL_RESOURCE_ATTRIBUTES: maykin.saas.client=maykin,maykin.saas.target=dev
      OTEL_METRIC_EXPORT_INTERVAL: ${OTEL_METRIC_EXPORT_INTERVAL:-60000}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4317}  # gRPC
      # otel:supersecret, escape spaces and = with percent encoding
      OTEL_EXPORTER_OTLP_HEADERS: Authorization=Basic b3RlbDpzdXBlcnNlY3JldA==
      OTEL_EXPORTER_OTLP_METRICS_INSECURE: ${OTEL_EXPORTER_OTLP_METRICS_INSECURE:-true}
      _OTEL_ENABLE_CONTAINER_RESOURCE_DETECTOR: true
    volumes:
      - log:/app/log
    ports:
      - 8000:8000
    depends_on:
      web-init:
        condition: service_completed_successfully
    labels:
      - app=objecttypes-api
      - service=api
    networks:
      - objecttypes-api-dev


  web-init:
    image: maykinmedia/objecttypes-api:${TAG:-latest}
    environment:
      <<: *app-env
      #
      # Django-setup-configuration
      RUN_SETUP_CONFIG: ${RUN_SETUP_CONFIG:-true}
    command: /setup_configuration.sh
    volumes:
      - log:/app/log
      - ./docker/setup_configuration:/app/setup_configuration
    depends_on:
      - db
    networks:
      - objecttypes-api-dev

volumes:
  db:
  log:

networks:
  objecttypes-api-dev:
    name: objecttypes-api-dev
